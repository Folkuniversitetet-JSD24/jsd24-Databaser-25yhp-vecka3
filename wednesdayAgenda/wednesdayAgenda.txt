ğŸ§¾ Lektionsplanering â€“ Onsdag 28 maj 2025
â° Tid: 13.00â€“16.00
ğŸ¯ Fokus: Kombinera modeller, djupare anvÃ¤ndning av .populate() och .aggregate()
ğŸ§  Pedagogiskt fokus: fÃ¶rdjupning i relationer och databehandling i Mongoose, samt fÃ¶rberedelse infÃ¶r examination

-----------------------------
ğŸ¯ Syfte

Koppla ihop flera modeller (User, Movie, Review) i relationsflÃ¶den

AnvÃ¤nda .populate() pÃ¥ flera nivÃ¥er (t.ex. hÃ¤mta bÃ¥de anvÃ¤ndare och film fÃ¶r en recension)

Skapa och fÃ¶rstÃ¥ .aggregate()-pipelines (â‰ˆ SQL GROUP BY) med $group, $match, $sort, $project, $limit

Bygga rutter som sammanstÃ¤ller och strukturerar data

TrÃ¤na pÃ¥ Postman-testning av relationer och sammanstÃ¤llningar

FÃ¶rbereda infÃ¶r kommande individuella examinationen

-----------------------------
ğŸ§  Agenda

Code review (peer feedback)
Teori â€“ CRUD + populate
Code-Along 1 â€“ CRUD, ref
Teori + Code-Along 2 â€“ .aggregate()
SjÃ¤lvstÃ¤ndig Ã¶vning: pipelines
Examination & Q&A

-----------------------------
-----------------------------
-----------------------------
ğŸ§  TEORI

ğŸ—£ï¸ CRUD i Mongoose

â€œMongoose ger oss enkla metoder fÃ¶r att skapa, lÃ¤sa, uppdatera och ta bort dokument. Det pÃ¥minner om ORM-verktyg i andra sprÃ¥k.â€

.create(), .find(), .findById()

.findByIdAndUpdate(), .findByIdAndDelete()

.populate() â€“ anvÃ¤nds fÃ¶r att hÃ¤mta hela relaterade dokument

ğŸ—£ï¸ Vad Ã¤r .aggregate()?

â€œMongoDB:s aggregate() liknar SQL:s GROUP BY, JOIN, HAVING, men anvÃ¤nder istÃ¤llet en pipeline av transformationer.â€

â€œVi skickar in en array med steg â€“ varje steg Ã¤r en transformation: $match, $group, $sort, $project, osv.â€

En aggregation pipeline i MongoDB fungerar som ett produktionsband â€“ varje steg modifierar datan och skickar vidare till nÃ¤sta. Det Ã¤r exakt som en kedja av .map(), .filter() och .sort() i JavaScript â€“ men det sker direkt i databasen och Ã¤r mycket effektivare.

ğŸ“Š JÃ¤mfÃ¶relse: SQL vs MongoDB

| SQL                      | MongoDB Mongoose                    |
|--------------------------|-------------------------------------|
| SELECT * FROM            | .find()                             |
| JOIN                     | .populate() eller $lookup           |
| GROUP BY category        | { $group: { _id: "$category" }}     |
| ORDER BY created_at      | { $sort: { createdAt: -1 }}         |
| SELECT col1, col2        | { $project: { col1: 1, col2: 1 }}   |

-----------------------------
-----------------------------
-----------------------------
ğŸ’» Code-Along â€“ User, Movie, Review: CRUD + Ref + populate + aggregate

ğŸ“ Projektstruktur:
rootmappen/
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ User.js
â”‚   â”œâ”€â”€ Movie.js
â”‚   â””â”€â”€ Review.js
â”œâ”€â”€ index.js
â”œâ”€â”€ .env

âœ… MODELLER

models/User.js
GenomfÃ¶r den koden

models/Movie.js
GenomfÃ¶r den koden

models/Review.js
GenomfÃ¶r den koden

index.js
GenomfÃ¶r den koden

-----------------------------
-----------------------------
-----------------------------
âœ… Verifiera att allt fungerar â€“ Testa i Postman

1. Skapa en anvÃ¤ndare

Method: POST

URL: http://localhost:3210/users

Body (JSON):
{
  "name": "filmfan123",
  "email": "fan@example.com"
}

ğŸ“Œ FÃ¶rvÃ¤ntat svar: 
{
  "_id": "...",
  "name": "filmfan123",
  "email": "fan@example.com",
  "__v": 0
}

-----------------------------
2. Skapa film:

Method: POST

URL: http://localhost:3210/movies

Body (JSON):
{
  "title": "Interstellar",
  "genre": "Sci-Fi",
  "releaseYear": 2014,
  "director": "Christopher Nolan"
}

ğŸ“Œ FÃ¶rvÃ¤ntat svar: Filmobjekt med _id och Ã¶vriga fÃ¤lt

-----------------------------
3. Skapa recension:

Method: POST

URL: http://localhost:3210/reviews

Body (JSON):
{
  "rating": 5,
  "comment": "Magisk film!",
  "movieId": "<id frÃ¥n filmen>",
  "userId": "<id frÃ¥n anvÃ¤ndaren>"
}

ğŸ“Œ FÃ¶rvÃ¤ntat svar: Recensionsobjekt med createdAtCA, _id, etc.

-----------------------------
4. HÃ¤mta relationer

GET http://localhost:3210/reviews

En array dÃ¤r varje objekt innehÃ¥ller en inbÃ¤ddad user och movie med deras namn/titel.

-----------------------------
5. HÃ¤mta betygssammanstÃ¤llning

GET http://localhost:3210/movies/ratings

âœ Returnerar en array med filmer:
{
  "_id": {
    "titleCA": "Interstellar",
    "genreCA": "Sci-Fi"
  },
  "avgRatingCA": 4.75,
  "reviewCountCA": 8
}

-----------------------------
6. Topplista â€“ endast bra filmer

Method: GET

URL: http://localhost:3210/movies/top-sci-fi

ğŸ“Œ FÃ¶rvÃ¤ntat svar:
En array med max 3 filmer, dÃ¤r varje objekt innehÃ¥ller:
{
  "title": "Interstellar",
  "genre": "Sci-Fi",
  "avgRating": 4.8
}

-----------------------------
-----------------------------
-----------------------------
Dags fÃ¶r Ã¶vningar

-----------------------------
-----------------------------
-----------------------------
ğŸ” Gruppdiskussion 

VarfÃ¶r inte bÃ¤dda in recensioner direkt i filmen?

NÃ¤r Ã¤r det bÃ¤ttre att anvÃ¤nda .aggregate() Ã¤n att hÃ¤mta alla reviews och rÃ¤kna sjÃ¤lv i Node?